<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- ICONS -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <!-- STYLESHEET -->
  <link rel="stylesheet" href="../css/dashCss/dash.css" />

  <title>Dashboard-Suporte</title>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <div class="menu-btn">
        <i class="ph-bold ph-caret-left"></i>
      </div>
      <div class="head">
        <div class="user-img">
          <img src="../assets/imgs/contact.png" alt="" />
        </div>
        <div class="user-details">
          <p class="title" id="cargoUsuario"></p>
          <p class="name" id="nomeUsuario"></p>
        </div>
      </div>
      <div class="nav">
        <div class="menu">
          <p class="title">Menu</p>
          <ul>
            <ul class="sub-menu">
              <li>
                <a href="#">
                  <span class="text">Users</span>
                </a>
              </li>
              <li>
                <a href="#">
                  <span class="text">Subscribers</span>
                </a>
              </li>
            </ul>
            </li>
            <li>
              <a href="dashSuporte.html">
                <i class="icon ph-bold ph-chart-bar"></i>
                <span class="text">Urgências</span>
              </a>
            </li>
            <li>
              <a href="graficoSuporte.html" class="opcaoAtual">
                <i class="icon ph-bold ph-chart-bar"></i>
                <span class="text">Gráficos</span>
              </a>
            </li>
          </ul>
        </div>
        <div class="menu">
          <p class="title"></p>
          <ul>
            <li>

            </li>
          </ul>
        </div>
      </div>
      <div class="menu">
        <p class="title">Conta</p>
        <ul>

          <li>
            <a href="../index.html">
              <i class="icon ph-bold ph-sign-out"></i>
              <span class="text">Sair</span>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <div class="credits">
      <div class="opcoes">
        <select id="selectServidor" class="botaoOp" onchange="listarServidores()">
        </select>
        <select id="selectComponente" class="botaoOp" onchange="plotarGrafico()">
          <option value="">Componente: </option>
          <option id="cpuRam" value="cpuRam">CPU E RAM %</option>
          <option id="dadosRec" value="dadosRec">Dados Recebidos</option>
          <option id="dadosEnv" value="dadosEnv">Dados Enviados</option>
        </select>
      </div>
      <div id="graficos">
          <div id="grafico1" class="display-block">
            <div id="tituloDashCpuERam" class="tituloDashCpuERam"></div>
            <div id="situacao" class="situacaoComp"></div>
          <div class="percentuais">
            <div id="percentCpu" class="percentCpu"></div>
            <div id="percentRam" class="percentRam"></div>
          </div>
            <div id="dimensaoGraficoCpu" class="dimensaoGraficoCpu">
              <div class="corFundoGrafico">
            <div id="graficoCpuERam" width="400" height="200"></div>
          </div> 
          </div>  
          </div>

          <div id="grafico2" class="display-none">
          <div id="redeRecebida"></div>

          <div id="graficoDadosRec" width="400" heigth="200"></div>
        </div>

        <div id="grafico3" class="display-none">
          <div id="redeEnviada"></div>

          <div id="graficoDadosEnv" width="400" heigth="200"></div>
        </div>
        </div>
    </div>
    <script>
      let proximaAtualizacao;
      // var idServidorSelecionado = parseInt(selectServidor.value);
      // var idServidor = sessionStorage.getItem("idServidor",);
      //  console.log(idServidor);
      
      function listarServidores(){
        var idEmpresa = sessionStorage.ID_EMPRESA;

        console.log('Buscando servidores...');

        fetch(`/servidores/buscarServidor/${idEmpresa}`, {
      method: "GET",
    })
    .then(function (resposta) {
      if(!resposta.ok){
        throw new Error(`Erro na requisição: ${resposta.status}`);
      }
        resposta.json().then((servidores) => {
          selectServidor.innerHTML = "";
          servidores.forEach((servidor) => {
            selectServidor.innerHTML += `<option value='${servidor.idServidor}'> Servidor ${servidor.idServidor}</option>`;

          });
          var idServidorPadrao = sessionStorage.getItem("idServidor");

        if (!idServidorPadrao) {
          // Se não houver valor no sessionStorage, pega o primeiro servidor como padrão
          idServidorPadrao = servidores[0].idServidor;
          sessionStorage.setItem("idServidor", idServidorPadrao);
          console.log("Valor inicial do idServidor armazenado:", idServidorPadrao);
        }
        selectServidor.value = idServidorPadrao;
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
      plotarGrafico();
    }
    selectServidor.addEventListener("change", () => {
          var idServidorSelecionado = parseInt(selectServidor.value);
          if (!isNaN(idServidorSelecionado)) {
            console.log(`O valor selecionado é ${idServidorSelecionado}`);
            sessionStorage.setItem("idServidor", idServidorSelecionado);
            // location.reload();
            plotarGraficoCpueRam();
          }
        });

      function esconderTodosOsGraficos() {
            let todosOsGraficos = document.getElementById("graficos");

            //Removendo ou adicionando classes
            
            for (var i = 1; i <= todosOsGraficos.childElementCount; i++) {
                let elementoAtual = document.getElementById(`grafico${i}`);
                elementoAtual.classList.remove("display-block");
                elementoAtual.classList.add("display-none");
            }
        }

        function plotarGrafico(idServidor) {

          var idServidor = sessionStorage.getItem("idServidor");

    const select = document.getElementById("selectComponente");
    var valorSelecionado = select.value;

    console.log("Valor selecionado: " + valorSelecionado);

    let todosOsGraficos = document.getElementById("graficos");

    if (valorSelecionado === "cpuRam") {
      exibirGraficoCpuEram(1);
     }// else if (valorSelecionado === "dadosRec") {
      // exibirGraficoDadosRec(2);
     //} else if (valorSelecionado === "dadosEnv") {
       //exibirGraficoDadosEnv(3);
     //}
  }

  window.onload = function(){
     listarServidores();
    // mudarServidor();
    obterDadosGraficos();
  };  

    function obterDadosGraficos() {

         obterDadosGraficoCpueRam()
         obterDadosGraficoDadosRec()
         obterDadosGraficoDadosEnv()
    }

  function exibirGraficoCpuEram(idServidor){

    var idServidor = sessionStorage.getItem("idServidor");

    let todosOsGraficos = document.getElementById("graficos");

  document.getElementById("grafico1").classList.remove("display-none"); 
  document.getElementById("grafico1").classList.add("display-block");

  document.getElementById("cpuRam").classList.add("active");

  const cpuRamElement = document.getElementById("cpuRam");
    if (cpuRamElement) {
        cpuRamElement.classList.add("active");
        console.log("Tudo certo")
    } else {
        console.error('Elemento cpuRam não encontrado!');
    }

     obterDadosGraficoCpueRam();
  }

  // function exibirGraficoDadosRec(idServidor){

  //   let todosOsGraficos = document.getElementById("graficos");

  // document.getElementById("grafico2").classList.remove("display-none"); 
  // document.getElementById("grafico2").classList.add("display-block");

  // document.getElementById("dadosRec").classList.add("active");

  // obterDadosGraficoDadosRec();
  // }

//   function exibirGraficoDadosEnv(idServidor){

// let todosOsGraficos = document.getElementById("graficos");

// document.getElementById("grafico3").classList.remove("display-none"); 
// document.getElementById("grafico3").classList.add("display-block");

// document.getElementById("dadosEnv").classList.add("active");

// obterDadosGraficoDadosEnv();
// }

  function obterDadosGraficoCpueRam(idServidor) {

    var idServidor = sessionStorage.getItem("idServidor");
    console.log(idServidor);

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        console.log('ID do Servidor:', idServidor);

      if (!idServidor) {
        console.error('O ID do servidor não está definido!');
        return; 
    }

      setInterval(() =>{
        //Faz uma requisição para obter os dados do Quiz
        fetch(`/dashboard/buscarCpueRam/${idServidor}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGraficoCpueRam(resposta, idServidor);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                console.error(error);
            });}, 1000);
    }

//    function obterDadosGraficoDadosRec(idServidor){

//     if (proximaAtualizacao != undefined) {
//             clearTimeout(proximaAtualizacao);
//         }

//         console.log('ID do Servidor:', idServidor);

//       if (!idServidor) {
//         console.error('O ID do servidor não está definido!');
//         return; 
//     }

//       setInterval(() =>{
//         //Faz uma requisição para obter os dados do Quiz
//         fetch(`/dashboard/buscarDadosRec/${idServidor}`, { cache: 'no-store' }).then(function (response) {
//             if (response.ok) {
//                 response.json().then(function (resposta) {
//                     console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
//                     resposta.reverse();

//                     plotarGraficoRec(resposta, idServidor);

//                 });
//             } else {
//                 console.error('Nenhum dado encontrado ou erro na API');
//             }
//         })
//             .catch(function (error) {
//                 console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
//                 console.error(error);
//             });}, 1000);
//    }

//    function obterDadosGraficoDadosEnv(idServidor){

//     if (proximaAtualizacao != undefined) {
//             clearTimeout(proximaAtualizacao);
//         }

//         console.log('ID do Servidor:', idServidor);

//       if (!idServidor) {
//         console.error('O ID do servidor não está definido!');
//         return; 
//     }

//       setInterval(() =>{
//         //Faz uma requisição para obter os dados do Quiz
//         fetch(`/dashboard/buscarDadosEnv/${idServidor}`, { cache: 'no-store' }).then(function (response) {
//             if (response.ok) {
//                 response.json().then(function (resposta) {
//                     console.log(`Dados enviados: ${JSON.stringify(resposta)}`);
//                     resposta.reverse();

//                     plotarGraficoEnv(resposta, idServidor);

//                 });
//             } else {
//                 console.error('Nenhum dado encontrado ou erro na API');
//             }
//         })
//             .catch(function (error) {
//                 console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
//                 console.error(error);
//             });}, 1000);
//    }

//    function plotarGraficoRec(resposta, idServidor){

//     console.log("Iniciando plotagem do gráfico...");

//     const labels = resposta.map((item) => item.hora).reverse();
//     const dadosRec = resposta.map((item) => item.recebido_rede).reverse();

//     redeRecebida.innerHTML = `<p>REDE RECEBIDA: ${dadosRec[dadosRec.length - 1]} GB`;

//       const options = {
//         chart: {
//             type: 'area',
//             height: 350,
//             animations: {
//                 enabled: true,
//                 easing: 'linear',
//                 dynamicAnimation: {
//                     speed: 1000,
//                 },
//             },
//         },
//         series: [
//             {
//                 name: 'Rede Recebida (GB)',
//                 data: dadosRec,
//             },
//         ],
//         xaxis: {
//             categories: labels,
//             title: {
//                 text: 'Hora',
//             },
//         },
//         yaxis: {
//             title: {
//                 text: 'Rede Recebida (GB)',
//             },
//         },
//         fill: {
//             type: 'gradient',
//             gradient: {
//                 shadeIntensity: 1,
//                 opacityFrom: 0.7,
//                 opacityTo: 0.9,
//                 stops: [0, 90, 100],
//             },
//         },
//         colors: ['#008FFB'],
//         dataLabels: {
//             enabled: false,
//         },
//         stroke: {
//             curve: 'smooth',
//         },
//     };

//     if (!chart) {
//         // Inicializa o gráfico na primeira vez
//         chart = new ApexCharts(document.querySelector("#graficoDadosRec"), options);
//         chart.render();
//     } else {
//         // Atualiza o gráfico nas próximas vezes
//         chart.updateOptions({
//             series: [
//                 {
//                     name: 'Rede Recebida (GB)',
//                     data: dadosRec,
//                 },
//             ],
//             xaxis: {
//                 categories: labels,
//             },
//         });
//     }
//    }

//    function plotarGraficoEnv(resposta, idServidor){

// console.log("Iniciando plotagem do gráfico...");

// const labels = resposta.map((item) => item.hora).reverse();
// const dadosEnv = resposta.map((item) => item.enviado_rede).reverse();

// redeEnviada.innerHTML = `<p>REDE ENVIADA: ${dadosEnv[dadosEnv.length - 1]} GB`;

//   const options = {
//     chart: {
//         type: 'area',
//         height: 350,
//         animations: {
//             enabled: true,
//             easing: 'linear',
//             dynamicAnimation: {
//                 speed: 1000,
//             },
//         },
//     },
//     series: [
//         {
//             name: 'Rede Recebida (GB)',
//             data: dadosEnv,
//         },
//     ],
//     xaxis: {
//         categories: labels,
//         title: {
//             text: 'Hora',
//         },
//     },
//     yaxis: {
//         title: {
//             text: 'Rede Recebida (GB)',
//         },
//     },
//     fill: {
//         type: 'gradient',
//         gradient: {
//             shadeIntensity: 1,
//             opacityFrom: 0.7,
//             opacityTo: 0.9,
//             stops: [0, 90, 100],
//         },
//     },
//     colors: ['#008FFB'],
//     dataLabels: {
//         enabled: false,
//     },
//     stroke: {
//         curve: 'smooth',
//     },
// };

// if (!chart) {
//     // Inicializa o gráfico na primeira vez
//     chart = new ApexCharts(document.querySelector("#graficoDadosEnv"), options);
//     chart.render();
// } else {
//     // Atualiza o gráfico nas próximas vezes
//     chart.updateOptions({
//         series: [
//             {
//                 name: 'Rede Enviada (GB)',
//                 data: dadosEnv,
//             },
//         ],
//         xaxis: {
//             categories: labels,
//         },
//     });
// }
// }

    let chart;

    function plotarGraficoCpueRam(resposta, idServidor) {
    console.log('Iniciando plotagem do gráfico...');
    var idServidor = sessionStorage.getItem("idServidor",);

    console.log(idServidor);

    tituloDashCpuERam.innerHTML = `<p> Relação da porcentagem de CPU e RAM</p>`;
    situacao.innerHTML = `<p> Situação em Tempo Real: </p>`; 

    const labels = resposta.map((item) => item.hora).reverse();
    const dadosCpu = resposta.map((item) => item.percent_use_cpu).reverse(); 
    const dadosRam = resposta.map((item) => item.percent_use_ram).reverse();

    percentCpu.innerHTML = `<p>CPU: ${dadosCpu[dadosCpu.length - 1]} %</p>`;
    percentRam.innerHTML = `<p>RAM: ${dadosRam[dadosRam.length - 1]} %</p>`; 

    console.log('Labels:', labels);
    console.log('Dados CPU:', dadosCpu);
    console.log('Dados RAM :', dadosRam);

    if (!chart) {
        // Criar o gráfico uma vez
        const options = {
            chart: {
                type: 'line',
                height: 400,
                width: 600,
                animations: {
                    enabled: true,
                    easing: 'linear',
                    dynamicAnimation: {
                        speed: 1000
                    }
                }
            },
            series: [
                {
                    name: 'Uso de CPU (%)',
                    data: dadosCpu
                },
                {
                    name: 'Uso de RAM (%)',
                    data: dadosRam
                }
            ],
            xaxis: {
                categories: labels,
                title: {
                    text: 'Período/Tempo'
                },
                labels: {
                    rotate: -45
                }
            },
            yaxis: {
                title: {
                    text: 'Percentual (%)'
                },
                min: 0,
                max: 100
            },
            colors: ['#36A2EB', '#FF6384'],
            stroke: {
                width: 1.7,
                curve: 'straight'
            },
            tooltip: {
                enabled: true,
                theme: 'dark',
                x: {
                    show: true,
                    format: 'HH:mm'
                },
                y: {
                    formatter: (value) => `${value}%`
                }
            },
            legend: {
                position: 'top',
            },
            responsive: [{
                breakpoint: 600,
                options: {
                    chart: {
                        height: 300
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }]
        };

        chart = new ApexCharts(document.querySelector("#graficoCpuERam"), options);
        chart.render();
    } else {
        // Atualizar apenas os dados do gráfico
        chart.updateOptions({
            xaxis: {
                categories: labels
            }
        });
        chart.updateSeries([
            {
                name: 'Uso de CPU (%)',
                data: dadosCpu
            },
            {
                name: 'Uso de RAM (%)',
                data: dadosRam
            }
        ]);
    }
  
}


    </script>