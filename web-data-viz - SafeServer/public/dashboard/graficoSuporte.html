<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- ICONS -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <!-- STYLESHEET -->
  <link rel="stylesheet" href="../css/dashCss/dash.css" />

  <title>Dashboard-Suporte</title>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <div class="menu-btn">
        <i class="ph-bold ph-caret-left"></i>
      </div>
      <div class="head">
        <div class="user-img">
          <img src="../assets/imgs/contact.png" alt="" />
        </div>
        <div class="user-details">
          <p class="title" id="cargoUsuario"></p>
          <p class="name" id="nomeUsuario"></p>
        </div>
      </div>
      <div class="nav">
        <div class="menu">
          <p class="title">Menu</p>
          <ul>
            <ul class="sub-menu">
              <li>
                <a href="#">
                  <span class="text">Users</span>
                </a>
              </li>
              <li>
                <a href="#">
                  <span class="text">Subscribers</span>
                </a>
              </li>
            </ul>
            </li>
            <li>
              <a href="dashSuporte.html">
                <i class="icon ph-bold ph-chart-bar"></i>
                <span class="text">Urgências</span>
              </a>
            </li>
            <li>
              <a href="graficoSuporte.html" class="opcaoAtual">
                <i class="icon ph-bold ph-chart-bar"></i>
                <span class="text">Gráficos</span>
              </a>
            </li>
          </ul>
        </div>
        <div class="menu">
          <p class="title"></p>
          <ul>
            <li>

            </li>
          </ul>
        </div>
      </div>
      <div class="menu">
        <p class="title">Conta</p>
        <ul>

          <li>
            <a href="../index.html">
              <i class="icon ph-bold ph-sign-out"></i>
              <span class="text">Sair</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="credits">
      <div class="opcoes">
        <select class="botaoOp">
          <option value="#"> Servidor: </option>
        </select>
        <select id="selectComponente" class="botaoOp" onchange="plotarGrafico()">
          <option value="">Componente: </option>
          <option id="cpuRam" value="cpuRam">CPU E RAM %</option>
          <option value="dadosRec"></option>
          <option value="dadosEnv"></option>
        </select>
      </div>
      <div id="graficos">
          <div id="grafico1" class="display-block">
            <div id="tituloDashCpuERam" class="tituloDashCpuERam"></div>
            <div id="situacao" class="situacaoComp"></div>
            <div id="percentCpu" class="percentCpu"></div>
            <div id="percentRam" class="percentRam"></div>
            <div class="dimensaoGraficoCpu">
              <div class="corFundoGrafico">
            <div id="graficoCpuERam" width="400" height="200"></div>
          </div> 
          </div>  
          </div>

          <div id="grafico2" class="display-none"></div>
        </div>
    </div>
    <script>
      var idServidor = sessionStorage.ID_SERVIDOR;
      let proximaAtualizacao;
       function esconderTodosOsGraficos() {
            let todosOsGraficos = document.getElementById("graficos");

            //Removendo ou adicionando classes
            
            for (var i = 1; i <= todosOsGraficos.childElementCount; i++) {
                let elementoAtual = document.getElementById(`grafico${i}`);
                elementoAtual.classList.remove("display-block");
                elementoAtual.classList.add("display-none");
            }
        }

        function plotarGrafico(idServidor) {

          console.log(document.getElementById("grafico1"));

    const select = document.getElementById("selectComponente");
    var valorSelecionado = select.value;

    console.log("Valor selecionado: " + valorSelecionado);

    let todosOsGraficos = document.getElementById("graficos");

    if (valorSelecionado === "cpuRam") {
      exibirGraficoCpuEram(1);
     } //else if (valorSelecionado === "dadosRec") {
    //   exibirGraficoDadosRec();
    // } else if (valorSelecionado === "dadosEnv") {
    //   exibirGraficoDadosEnv();
    // }
  }

  window.onload = obterDadosGraficos();
    //função utilizada para obter dados das funções "exibirDadosQuiz" e "exibirDadosEmocao"

    function obterDadosGraficos() {

        obterDadosGraficoCpueRam(1)
    }

  function exibirGraficoCpuEram(idServidor){

    let todosOsGraficos = document.getElementById("graficos");

    if (grafico1) {  // Verifica se grafico1 existe
        grafico1.classList.remove("display-none");
        grafico1.classList.add("display-block");
    } else {
        console.error("Elemento #grafico1 não encontrado!");
    }
    let cpuRam = document.getElementById("cpuRam");
    
    if (cpuRam) { 
        cpuRam.classList.add("active");
    } else {
        console.error("Elemento #cpuRam não encontrado!");
    }

  document.getElementById("grafico1").classList.remove("display-none"); 
  document.getElementById("grafico1").classList.add("display-block");

  document.getElementById("cpuRam").classList.add("active");

  const cpuRamElement = document.getElementById("cpuRam");
    if (cpuRamElement) {
        cpuRamElement.classList.add("active");
        console.log("Tudo certo")
    } else {
        console.error('Elemento cpuRam não encontrado!');
    }

    obterDadosGraficoCpueRam();
  }

  function obterDadosGraficoCpueRam(idServidor) {

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        console.log('ID do Servidor:', idServidor);

      if (!idServidor) {
        console.error('O ID do servidor não está definido!');
        return; // Impede a requisição se não tiver um ID de servidor
    }

        //Faz uma requisição para obter os dados do Quiz
        fetch(`/dashboard/buscarCpueRam/${idServidor}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGraficoCpueRam(resposta, idServidor);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                console.error(error);
            });
    }

    function plotarGraficoCpueRam(resposta, idServidor) {
    console.log('Iniciando plotagem do gráfico com ApexCharts...');

    // Elementos HTML para exibir os títulos e situação em tempo real
    tituloDashCpuERam.innerHTML = `<p> Relação da porcentagem de CPU e RAM</p>`;
    situacao.innerHTML = `<p> Situação em Tempo Real: </p>`; 

    // Mapear os dados de resposta para os eixos do gráfico
    const labels = resposta.map((item) => {
        // Formatar a data para mostrar apenas a hora e os minutos
        const dataHora = new Date(item.dtHora);
        const hora = dataHora.getHours().toString().padStart(2, '0'); // Garantir que a hora tenha 2 dígitos
        const minutos = dataHora.getMinutes().toString().padStart(2, '0');
        const segundos = dataHora.getSeconds().toString().padStart(2, '0');
        return `${hora}:${minutos}:${segundos}`; 
        return `${hora}:${minutos}:${segundos}`; // Retorna a hora formatada
    });

    const dadosCpu = resposta.map((item) => item.percent_use_cpu); 
    const dadosRam = resposta.map((item) => item.percent_use_ram);

    console.log("Dados de CPU:", dadosCpu);
    console.log("Dados de RAM:", dadosRam);
    console.log("Labels:", labels);
    console.log("Hora dos dados:", resposta.map(item => item.dtHora));

    percentCpu.innerHTML = `<p>${dadosCpu[dadosCpu.length - 1]}%</p>`;
    percentRam.innerHTML = `<p>${dadosRam[dadosRam.length - 1]}%</p>`; 

    // Configurações do gráfico ApexCharts
    const options = {
        series: [
            {
                name: 'Uso de CPU (%)',
                data: dadosCpu.map((value, index) => ({ x: labels[index], y: value })),
                color: '#0000FF'
            },
            {
                name: 'Uso de RAM (%)',
                data: dadosRam.map((value, index) => ({ x: labels[index], y: value })),
                color: '#FF0000'
            }
        ],
        chart: {
            id: 'realtime',
            height: 350,
            type: 'line',
            animations: {
                enabled: true,
                easing: 'linear',
                dynamicAnimation: {
                    speed: 1000
                }
            },
            toolbar: {
                show: false
            },
            zoom: {
                enabled: false
            }
        },
        dataLabels: {
            enabled: false
        },
        stroke: {
            curve: 'smooth'
        },
        title: {
            text: '',
            align: 'left'
        },
        xaxis: {
            type: 'category',
            categories: labels,
            title: {
                text: 'Período/Tempo',
            }
        },
        yaxis: {
            max: 100,
            min: 0,
            title: {
                text: 'Percentual (%)'
            }
        },
        tooltip: {
            enabled: true,
            x: {
                format: 'HH:mm'
            },
            y: {
                formatter: function (val) {
                    return `${val}%`;
                }
            }
        },
        legend: {
            position: 'top'
        }
    };

    // Inicializando o gráfico ApexCharts no elemento HTML
    const chart = new ApexCharts(document.querySelector("#graficoCpuERam"), options);
    chart.render();
}


    </script>