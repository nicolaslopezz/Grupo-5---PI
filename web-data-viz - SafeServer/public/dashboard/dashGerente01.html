<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- ICONS -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <!-- STYLESHEET -->
  <link rel="stylesheet" href="../css/dashCss/dash.css" />

  <title>Dashboard-Gerente</title>
</head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<body>
  <div class="container">
    <div class="sidebar">
      <div class="menu-btn">
        <i class="ph-bold ph-caret-left"></i>
      </div>
      <div class="head">
        <div class="user-img">
          <img src="../assets/imgs/contact.png" alt="" />
        </div>
        <div class="user-details">
          <p class="title" id="cargoUsuario"></p>
          <p class="name" id="nomeUsuario"></p>
        </div>
      </div>
      <div class="nav">
        <div class="menu">
          <p class="title">Menu</p>
          <ul>
            <ul class="sub-menu">
              <li>
                <a href="#">
                  <span class="text">Users</span>
                </a>
              </li>
              <li>
                <a href="#">
                  <span class="text">Subscribers</span>
                </a>
              </li>
            </ul>
            </li>
            <li>
              <a href="relatorio.html">
                <i class="icon ph-bold ph-file-text"></i>
                <span class="text">Relatório</span>
              </a>
            </li>
            <li class="active">
              <a href="">
                <i class="icon ph-bold ph-chart-bar"></i>
                <span class="text">Gráfico</span>
              </a>
            </li>
            <li>
              <a href="cadastroServidor.html">
                <i class="icon ph-bold ph-gear"></i>
                <span class="text">Cadastrar Servidor</span>
              </a>
            </li>
          </ul>
        </div>
        <div class="menu">
          <p class="title"></p>
          <ul>
            <li>

            </li>
          </ul>
        </div>
      </div>
      <div class="menu">
        <p class="title">Conta</p>
        <ul>
          <li>
            <a href="../index.html">
              <i class="icon ph-bold ph-sign-out"></i>
              <span class="text">Sair</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="content-dash-gerente flex main">
      <div class="sidebar2">
        <div class="regiao discretizacao">
          <h1 class="bold">Regiões a serem mostradas</h1>
          <div class="">
            <button value="1" onclick="selecionar('button_1'), plotar()" id="button_1">US-EAST-1</button>
            <button value="1" onclick="selecionar('button_2'), plotar()" id="button_2">US-EAST-2</button>
            <button value="1" onclick="selecionar('button_3'), plotar()" id="button_3">US-EAST-3</button>
          </div>
        </div>
        <div class="componente discretizacao">
          <h1 class="bold">Componentes a serem mostrados</h1>
          <div class="">
            <button value="1" onclick="selecionar('button_4'), plotar()" id="button_4">CPU</button>
            <button value="1" onclick="selecionar('button_5'), plotar()" id="button_5">RAM</button>
            <button value="1" onclick="selecionar('button_6'), plotar()" id="button_6">Rede</button>
          </div>
        </div>
        <div class="tempo discretizacao">
          <h1 class="bold">Intervalo de tempo</h1>
          <div class="">
            <input class="slider" type="range" min="5" max="60" id="input_tempo" onpointermove="mostrar(1)"
              onchange="plotar()">
            <input type="number" name="" id="ipt_range" min="5" max="60" onchange="mostrar(2), plotar()">
            <span>Dias</span>
          </div>
        </div>
      </div>
      <div class="graficos-dash-gerente">
        <div class="dados-topo-gerente">
          <div class="dados-maiores-gerente style-shadow">
            <div style="width: 45%;">
              <h2 class="bold">Componente com mais alertas:</h2>
              <div id="div_componenteMaisAlertas"></div>
            </div>
            <div style="width: 45%;">
              <h2 class="bold">Região com mais alertas:</h2>
              <div id="div_regiaoMaisAlertas"></div>
            </div>
          </div>
          <div class="dados-componentes-gerente style-shadow">
            <canvas id="chart_componentes"></canvas>
          </div>
        </div>
        <div class="box-chart-gerente style-shadow">
          <canvas id="chart_alertas"></canvas>
        </div>
      </div>
    </div>
  </div>
</body>

</html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.js"
  integrity="sha512-8Z5++K1rB3U+USaLKG6oO8uWWBhdYsM3hmdirnOEWp8h2B1aOikj5zBzlXs8QOrvY9OxEnD2QDkbSKKpfqcIWw=="
  crossorigin="anonymous"></script>
<script src="../js/script.js"></script>
<script>
  obterDados()
  function obterDados() {

    var idEmpresa = sessionStorage.getItem("ID_EMPRESA");
    console.log(idEmpresa)

    fetch("/dashGerente/obterDados", {
      method: "POST",
      headers: {
        "Content-type": "application/json"
      },
      body: JSON.stringify({
        idEmpresaServer: idEmpresa
      })
    }).then(function (resposta) {
      if (resposta.ok) {
        console.log("DADOS RECEBIDOS:", resposta)
        resposta.json().then(valor => {
          console.log(valor)
          dadosTotal = valor;
          plotar(dadosTotal)
        })
        // plotar(dadosTotal)
        // plotagem = resposta.json().then(json => {
        //   console.log("dados:", json);
        //   dadosTotal = json;
        //   plotar(json);
        // })
      } else {
        console.log("Houve um erro ao receber os dados no dashGerente01.html")
      }
    }).catch(function (erro) {
      console.log("CATCH DO FETCH")
      console.log(erro)
    })
  }

  // Variáveis para armazenamento organizado dos dados
  let dadosTotal;

  const alertasCpuRaw = [];
  const alertasRamRaw = [];
  const alertasRedeRaw = [];

  let alertasCpuTrusted = [];
  let alertasRamTrusted = [];
  let alertasRedeTrusted = [];


  let labelsDatas = []
  let alertasFullCpu = []
  let alertasFullRam = []
  let alertasFullRede = []

  let regioes = [];
  let regioesDados = [];

  let totalAlertas = {
    cpu: 0,
    ram: 0,
    rede: 0,
  };

  // Canvas dos gráficos
  const id_chart_componentes = document.getElementById("chart_componentes");
  const id_chart_alertas = document.getElementById("chart_alertas");

  function plotar(dados) {

    // Colocando os valores nos vetores de cada componente
    for (i = 0; i < dados.length; i++) {
      if (dados[i].componente == "cpu") {
        totalAlertas.cpu += dados[i].alertas;
        alertasCpuRaw.push(dados[i])
      } else if (dados[i].componente == "ram") {
        totalAlertas.ram += dados[i].alertas;
        alertasRamRaw.push(dados[i])
      } else if (dados[i].componente == "rede") {
        totalAlertas.rede += dados[i].alertas;
        alertasRedeRaw.push(dados[i])
      }
    }

    // Mostrando componente com maior número de alertas
    if (totalAlertas.cpu > totalAlertas.ram && totalAlertas.cpu > totalAlertas.rede) {
      div_componenteMaisAlertas.innerHTML = `CPU`;
    } else if (totalAlertas.ram > totalAlertas.rede) {
      div_componenteMaisAlertas.innerHTML = `Ram`;
    } else {
      div_componenteMaisAlertas.innerHTML = `Rede`;
    }

    // Separando regiões e obtendo quantidade de cada um
    for (i = 0; i < dados.length; i++) {
      if (regioes.indexOf(dados[i].regiao) < 0) {
        regioes.push(dados[i].regiao)
        regioesDados.push({
          regiao: dados[i].regiao,
          alertas: dados[i].alertas
        });
      } else {
        regioesDados[regioes.indexOf(dados[i].regiao)].alertas += dados[i].alertas;
      }
    }

    // Verificando e exibindo região com maior número de alertas
    let regiaoMaisAlertas = regioesDados[0]
    for (i = 1; i < regioes.length; i++) {
      if (regioesDados[i].alertas > regiaoMaisAlertas.alertas) {
        regiaoMaisAlertas = regioes[i];
      }
    }
    div_regiaoMaisAlertas.innerHTML = regiaoMaisAlertas.regiao;

    // Limpando a memória
    regiaoMaisAlertas = null

    // Plotando grafico componentes
    chart_componentes = new Chart(id_chart_componentes, {
      type: 'doughnut',
      data: {
        labels: ['Ram', 'Cpu', 'Rede'],
        datasets: [{
          label: 'Dados Alerta Total',
          data: [totalAlertas.ram, totalAlertas.cpu, totalAlertas.rede],
          backgroundColor: [
            '#e28743',
            '#c6ccdd',
            '#485f96'
          ]
        }]
      },
    });

    // Limpando a memória
    totalAlertas = null

    // Eliminando lacunas nas datas dos alertas...
    const data_inicial = {
      dia: dados[0].dia,
      mes: dados[0].mes,
      ano: dados[0].ano,
    };

    const data_final = {
      dia: dados[dados.length - 1].dia,
      mes: dados[dados.length - 1].mes,
      ano: dados[dados.length - 1].ano,
    };

    if (alertasCpuRaw[0].dia == data_inicial.dia && alertasCpuRaw[0].mes == data_inicial.mes && alertasCpuRaw[0].ano == data_inicial.ano) {
      alertasCpuTrusted.push(alertasCpuRaw[0])
      i = 1
    } else {
      alertasCpuTrusted.push({ dia: data_inicial.dia, mes: data_inicial.mes, ano: data_inicial.ano, alertas: 0 })
      i = 0
    }
    for (;;) {
        if (alertasCpuTrusted[alertasCpuTrusted.length - 1].dia == data_final.dia &&
          alertasCpuTrusted[alertasCpuTrusted.length - 1].mes == data_final.mes &&
          alertasCpuTrusted[alertasCpuTrusted.length - 1].ano == data_final.ano
        ) { break; }
        if (i >= alertasCpuRaw.length) {
          alertasCpuTrusted.push({
            dia: adicionarUmDia(alertasCpuTrusted[alertasCpuTrusted.length - 1]).dia,
            mes: adicionarUmDia(alertasCpuTrusted[alertasCpuTrusted.length - 1]).mes,
            ano: adicionarUmDia(alertasCpuTrusted[alertasCpuTrusted.length - 1]).ano, alertas: 0
          })
        } else {
          if (alertasCpuRaw[i].dia == adicionarUmDia(alertasCpuTrusted[alertasCpuTrusted.length - 1]).dia &&
            alertasCpuRaw[i].mes == adicionarUmDia(alertasCpuTrusted[alertasCpuTrusted.length - 1]).mes &&
            alertasCpuRaw[i].ano == adicionarUmDia(alertasCpuTrusted[alertasCpuTrusted.length - 1]).ano) {
            alertasCpuTrusted.push(alertasCpuRaw[i])
            i++
          } else {
            alertasCpuTrusted.push({
              dia: adicionarUmDia(alertasCpuTrusted[alertasCpuTrusted.length - 1]).dia,
              mes: adicionarUmDia(alertasCpuTrusted[alertasCpuTrusted.length - 1]).mes,
              ano: adicionarUmDia(alertasCpuTrusted[alertasCpuTrusted.length - 1]).ano, alertas: 0
            })
          }
        }
    
    }

    for (i = 0; ;) {
      if (alertasRamTrusted.length == 0) {
        if (alertasRamRaw[i].dia == data_inicial.dia && alertasRamRaw[i].mes == data_inicial.mes && alertasRamRaw[i].ano == data_inicial.ano) {
          alertasRamTrusted.push(alertasRamRaw[i])
          i++
        } else {
          alertasRamTrusted.push({ dia: data_inicial.dia, mes: data_inicial.mes, ano: data_inicial.ano, alertas: 0 })
        }
      } else {
        if (alertasRamTrusted[alertasRamTrusted.length - 1].dia == data_final.dia &&
          alertasRamTrusted[alertasRamTrusted.length - 1].mes == data_final.mes &&
          alertasRamTrusted[alertasRamTrusted.length - 1].ano == data_final.ano
        ) { break; }
        if (i >= alertasRamRaw.length) {

          alertasRamTrusted.push({
            dia: adicionarUmDia(alertasRamTrusted[alertasRamTrusted.length - 1]).dia,
            mes: adicionarUmDia(alertasRamTrusted[alertasRamTrusted.length - 1]).mes,
            ano: adicionarUmDia(alertasRamTrusted[alertasRamTrusted.length - 1]).ano, alertas: 0
          })

        } else {
          if (alertasRamRaw[i].dia == adicionarUmDia(alertasRamTrusted[alertasRamTrusted.length - 1]).dia &&
            alertasRamRaw[i].mes == adicionarUmDia(alertasRamTrusted[alertasRamTrusted.length - 1]).mes &&
            alertasRamRaw[i].ano == adicionarUmDia(alertasRamTrusted[alertasRamTrusted.length - 1]).ano) {
            alertasRamTrusted.push(alertasRamRaw[i])
            i++
          } else {
            alertasRamTrusted.push({
              dia: adicionarUmDia(alertasRamTrusted[alertasRamTrusted.length - 1]).dia,
              mes: adicionarUmDia(alertasRamTrusted[alertasRamTrusted.length - 1]).mes,
              ano: adicionarUmDia(alertasRamTrusted[alertasRamTrusted.length - 1]).ano, alertas: 0
            })
          }
        }
      }
    }

    for (i = 0; ;) {
      if (alertasRedeTrusted.length == 0) {
        if (alertasRedeRaw[i].dia == data_inicial.dia && alertasRedeRaw[i].mes == data_inicial.mes && alertasRedeRaw[i].ano == data_inicial.ano) {
          alertasRedeTrusted.push(alertasRedeRaw[i])
          i++
        } else {
          alertasRedeTrusted.push({ dia: data_inicial.dia, mes: data_inicial.mes, ano: data_inicial.ano, alertas: 0 })
        }
      } else {
        if (alertasRedeTrusted[alertasRedeTrusted.length - 1].dia == data_final.dia &&
          alertasRedeTrusted[alertasRedeTrusted.length - 1].mes == data_final.mes &&
          alertasRedeTrusted[alertasRedeTrusted.length - 1].ano == data_final.ano
        ) { break; }
        if (i >= alertasRedeRaw.length) {
          alertasRedeTrusted.push({
            dia: adicionarUmDia(alertasRedeTrusted[alertasRedeTrusted.length - 1]).dia,
            mes: adicionarUmDia(alertasRedeTrusted[alertasRedeTrusted.length - 1]).mes,
            ano: adicionarUmDia(alertasRedeTrusted[alertasRedeTrusted.length - 1]).ano, alertas: 0
          })
        } else {
          if (alertasRedeRaw[i].dia == adicionarUmDia(alertasRedeTrusted[alertasRedeTrusted.length - 1]).dia &&
            alertasRedeRaw[i].mes == adicionarUmDia(alertasRedeTrusted[alertasRedeTrusted.length - 1]).mes &&
            alertasRedeRaw[i].ano == adicionarUmDia(alertasRedeTrusted[alertasRedeTrusted.length - 1]).ano) {
            alertasRedeTrusted.push(alertasRedeRaw[i])
            i++
          } else {
            alertasRedeTrusted.push({
              dia: adicionarUmDia(alertasRedeTrusted[alertasRedeTrusted.length - 1]).dia,
              mes: adicionarUmDia(alertasRedeTrusted[alertasRedeTrusted.length - 1]).mes,
              ano: adicionarUmDia(alertasRedeTrusted[alertasRedeTrusted.length - 1]).ano, alertas: 0
            })
          }
        }
      }
    }

    // Criando os labels com Todas as datas
    for (dataDaVez = data_inicial; dataDaVez.dia != adicionarUmDia(data_final).dia || dataDaVez.mes != adicionarUmDia(data_final).mes || dataDaVez.ano != adicionarUmDia(data_final).ano; dataDaVez = adicionarUmDia(dataDaVez)) {
      labelsDatas.push(`${dataDaVez.dia}/${dataDaVez.mes}/${(dataDaVez.ano).toString()[2]}${(dataDaVez.ano).toString()[3]}`)
    }

    for (i = 0; i < alertasCpuTrusted.length; i++) {
      alertasFullCpu.push(alertasCpuTrusted[i].alertas)
      alertasFullRam.push(alertasRamTrusted[i].alertas)
      alertasFullRede.push(alertasRedeTrusted[i].alertas)
    }

    // Limpando a memória
    // alertasCpuTrusted = null
    // alertasRamTrusted = null
    // alertasRedeTrusted = null

    dataChartAlertas = {}

    if (alertasFullCpu.length > 60) {
      // Limitando amostra inicial para 60 (caso haja mais de 60)
      auxCpu = []
      auxRam = []
      auxRede = []
      auxLabels = []
      console.log(alertasFullCpu)
      for (i = alertasFullCpu.length - 1; i > alertasCpuTrusted.length - 61; i--) {
        auxCpu.push(alertasFullCpu[i])
        auxRam.push(alertasFullRam[i])
        auxRede.push(alertasFullRede[i])
        auxLabels.push(labelsDatas[i])
      }
      auxCpu.reverse()
      auxRam.reverse()
      auxRede.reverse()
      auxLabels.reverse()

      dataChartAlertas = {
        labels: auxLabels,
        datasets: [{
          label: "Alertas CPU",
          data: auxCpu
        }, {
          label: "Alertas Ram",
          data: auxRam
        }, {
          label: "Alertas Rede",
          data: auxRede
        }
        ], backgroundColor: ['#e28743',
            '#c6ccdd',
            '#485f96']
      }
      // auxCpu = null
      // auxRam = null
      // auxRede = null
      // auxLabels = null
    } else {
      dataChartAlertas = {
        labels: labelsDatas,
        datasets: [{
          label: "Alertas CPU",
          data: alertasFullCpu
        }, {
          label: "Alertas Ram",
          data: alertasFullRam
        }, {
          label: "Alertas Rede",
          data: alertasFullRede
        }
        ], backgroundColor: ['#e28743',
            '#c6ccdd',
            '#485f96']
      }
    }

    chart_alertas = new Chart(id_chart_alertas, {
      type: 'bar',
      data: dataChartAlertas,
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            stacked: true,
            ticks: {
              color: "rgb(16, 46, 118)" // Cor dos rótulos no eixo Y
            }
          },
          x: {
            stacked: true,
            ticks: {
              color: "rgb(16, 46, 118)" // Cor dos rótulos no eixo X
            }
          }
        },
        plugins: {
          legend: {
            labels: {
              color: "rgb(16, 46, 118)" // Cor das labels da legenda
            }
          }
        }
      }
    });
  }

  function adicionarUmDia(bogos) {
    let data = {
      dia: bogos.dia,
      mes: bogos.mes,
      ano: bogos.ano
    }
    if (data.mes == 1 || data.mes == 3 || data.mes == 5 || data.mes == 7 || data.mes == 8 || data.mes == 10 || data.mes == 12) {
      // Meses com 31 dias
      if (data.dia == 31) {
        // Virada do mês
        data.dia = 1;
        if (data.mes == 12) {
          // Virada do ano
          data.mes = 1;
          data.ano += 1;
        } else {
          data.mes += 1;
        }
      } else {
        // Apenas um dia
        data.dia += 1;
      }
    } else if (data.mes == 2) {
      // Fevereiro
      if (data.ano % 4 == 0) {
        // Ano bissexto 
        if (data.dia == 29) {
          // Virada do mês
          data.dia = 1;
          data.mes = 3;
        } else {
          // Apenas um dia
          data.dia += 1;
        }
      } else if (data.dia == 28) {
        // Ano regular, passada do mês
        data.dia = 1;
        data.mes = 3;
      } else {
        // Passando apenas um dia
        data.dia += 1;
      }
    } else {
      if (data.dia == 30) {
        data.mes += 1;
        data.dia = 1;
      } else {
        data.dia++;
      }

    }
    return data;
  }

</script>