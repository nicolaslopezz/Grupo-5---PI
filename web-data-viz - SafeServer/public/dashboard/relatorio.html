<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- ICONS -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <!-- STYLESHEET -->
  <link rel="stylesheet" href="../css/dashCss/dash.css" />

  <!-- AnyChart Scripts -->
  <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-base.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-tag-cloud.min.js"></script>


  <!-- scripts do Chart.js - 2022-1 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <title>Relatório - Nuvem de Palavras</title>
</head>

<body>
  <div class="container">
    <div class="sidebar">
      <div class="menu-btn">
        <i class="ph-bold ph-caret-left"></i>
      </div>
      <div class="head">
        <div class="user-img">
          <img src="../assets/imgs/contact.png" alt="User Image" />
        </div>
        <div class="user-details">
          <p class="title" id="cargoUsuario"></p>
          <p class="name" id="nomeUsuario"></p>
        </div>
      </div>
      <div class="nav">
        <div class="menu">
          <p class="title">Menu</p>
          <ul>
            <li class="active">
              <a href="#">
                <i class="icon ph-bold ph-file-text"></i>
                <span class="text">Relatório</span>
              </a>
            </li>
            <li>
              <a href="dashGerente01.html">
                <i class="icon ph-bold ph-chart-bar"></i>
                <span class="text">Gráfico</span>
              </a>
            </li>
            <li>
              <a href="cadastroServidor.html">
                <i class="icon ph-bold ph-gear"></i>
                <span class="text">Cadastrar Servidor</span>
              </a>
            </li>
          </ul>
        </div>
        <div class="menu">
          <p class="title">Conta</p>
          <ul>
            <li>
              <a href="../index.html">
                <i class="icon ph-bold ph-sign-out"></i>
                <span class="text">Sair</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="credits">
      <div class="relatorioG">
        <div class="parteSuperior">
          <div class="containerSUP">
            <div class="supE">
              <div class="supTitulo">
                <h1>Feriados Globais Mais Populares:</h1>
              </div>
              <div class="supImg">
                <!-- Div para exibir a Word Cloud -->
                <div id="word" style="width: 100%; height: 200px;"></div>
              </div>
            </div>
            <div class="supD">
              <div class="intFeriado">
                <select id="feriadoSelect" onchange="obterServidorSelecionado()">
                 
                </select>
              </div>
              <div id="grafico"></div>
            </div>
          </div>
        </div>
        <div class="parteInferior">
          <div class="containerINF">

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Jquery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.js"
    integrity="sha512-8Z5++K1rB3U+USaLKG6oO8uWWBhdYsM3hmdirnOEWp8h2B1aOikj5zBzlXs8QOrvY9OxEnD2QDkbSKKpfqcIWw=="
    crossorigin="anonymous"></script>
  <script src="../js/script.js"></script>

  <!-- Fetch e criação da Word Cloud -->
  <script>
    var nomeUsuario = sessionStorage.getItem("NOME_USUARIO");
    var cargoUsuario = sessionStorage.getItem("CARGO");


    document.getElementById('nomeUsuario').textContent = nomeUsuario;
    document.getElementById('cargoUsuario').textContent = cargoUsuario;




    // Função para buscar dados dos feriados
    async function fetchFeriados() {
      console.log('Iniciando a requisição para /dashboard/wordcloud');

      try {
        const response = await fetch('/dashboard/wordcloud', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        });

        console.log('Resposta recebida do servidor:', response);

        // Verifica se a resposta foi bem-sucedida
        if (!response.ok) {
          throw new Error('Erro ao obter os dados dos feriados: ' + response.statusText);
        }

        const data = await response.json();
        console.log('Dados brutos recebidos:', data);

        // Formatar os dados para o gráfico de nuvem de palavras
        // Criação da lista de feriados usando forEach

        const holidaysTranslation = {
          "NewYearsDay": "Ano Novo",
          "ChristmasDay": "Natal",
          "GoodFriday": "Sexta-feira Santa",
          "EasterMonday": "Páscoa",
          "LabourDay": "Dia do Trabalho",
          "IndependenceDay": "Dia da Independência",
          "St.StephensDay": "Dia de Santo Estêvão",
          "EasterSunday": "Domingo de Páscoa",
          "AllSaintsDay": "Dia de Todos os Santos",
          "AscensionDay": "Dia da Ascensão",
          "WhitMonday": "Segunda-feira de Pentecostes",
          "Epiphany": "Dia de Reis",
          "AssumptionDay": "Assunção de Maria",
          "Carnival": "Carnaval",
          "ChristmasEve": "Véspera de Natal",
          "CorpusChristi": "Corpus Christi",
          "RegionalHoliday": "Feriado Regional",
          "MaundyThursday": "Quinta-feira Santa",
          "ImmaculateConception": "Imaculada Conceição",
          "NewYearsEve": "Véspera de Ano Novo"
        };

        // Array para armazenar os feriados
        const feriados = [];

        //  Itera sobre o array 'data' onde possui o nomeFeriado e a frequencia. Acessa o objeto de string e acessa a entidade relacionada a o nome do feriado em inglês e acessa o item com o nome do feriado traduzido armazenando no x caso o nome em ingles nao seja encontrado no objeto ele mantém o nome em inglês
        data.forEach(item => {
          feriados.push({
            x: holidaysTranslation[item.nomeFeriado] || item.nomeFeriado, // Traduz ou mantém o nome original
            value: item.frequencia // 'value' para a frequência
          });
        });

        console.log('Feriados processados:', feriados);
        createWordCloud(feriados);
      } catch (error) {
        console.error('Erro na requisição dos feriados:', error);
      }
    }

    // Função para criar a nuvem de palavras
    function createWordCloud(feriados) {
      console.log('Criando a word cloud com os seguintes feriados:', feriados);

      var chart = anychart.tagCloud(feriados);

      // definir cores 
      var customColor = anychart.scales.linearColor();
      customColor.colors(["#45b6fe", '#f94449', "#DE73FF"]);

      chart.colorScale(customColor);


      chart.angles([0, 45, -45]);
      chart.colorRange(true);
      chart.colorRange().length('90%');

      // config da escala de tamanho das palavras com base no valor de frequência
      chart.scale(anychart.scales.log()); // Usa uma escala logarítmica para equilibrar tamanhos
      chart.normal().fontSize(function () {

        //multiplica o valor da frequência, mas define um tamanho mínimo e máximo
        var freq = this.getData('value');
        var fontSize = freq * 0.4;

        // define tamanho 
        if (fontSize < 12) fontSize = 13; // Tamanho mínimo
        if (fontSize > 50) fontSize = 51; // Tamanho máximo

        return fontSize;
      });

      // Exibir o gráfico
      chart.container('word');
      chart.draw();

      console.log('Word cloud criada com sucesso!');
    }

    // Chama a função para buscar os feriados ao carregar a página
    fetchFeriados();

  </script>
</body>

</html>
<script>
// Função para fazer a requisição e preencher o <select> com servidores
  async function servidor() {
  const empresa = sessionStorage.ID_EMPRESA;
  console.log('Iniciando a requisição para /dashboard/servidor');

  try {
    const response = await fetch(`/dashboard/servidor/${empresa}`, {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' },
    });

    console.log('Resposta recebida do servidor:', response);

    if (!response.ok) {
      throw new Error('Erro ao obter os dados: ' + response.statusText);
    }

    const data = await response.json();
    console.log('Dados brutos recebidos:', data);

    if (Array.isArray(data)) {
      const servidores = data.map(item => item.identificacao); // Usando .map() para simplificar
      console.log('Servidores:', servidores);
      preencherSelectServidores(servidores);
    } else {
      console.error('Erro: A resposta não contém um array de servidores.');
    }
  } catch (error) {
    console.error('Erro na requisição', error);
  }
  
}

// Função para preencher o select com os servidores recebidos
function preencherSelectServidores(servidores) {
  const selectElement = document.getElementById("feriadoSelect");
  selectElement.innerHTML = ''; // Limpa as opções existentes

  servidores.forEach(servidor => {
    const option = document.createElement('option');
    option.value = servidor;
    option.textContent = servidor;
    selectElement.appendChild(option);
  });

  console.log('Select preenchido com sucesso.');
}

// Função que lida com a seleção do servidor no select
function obterServidorSelecionado() {
  const valorSelecionado = document.getElementById("feriadoSelect").value;
  console.log("Valor selecionado:", valorSelecionado);

  obterDadosGrafico(valorSelecionado);




  if (valorSelecionado) {
    return valorSelecionado;
  
 
  } else {
    console.log('Nenhuma opção selecionada ou o valor está vazio.');
    return null;
  }
}

// Função para exibir o canvas do gráfico e iniciar o processo de obtenção de dados
async function exibirPosts() {
  document.getElementById("grafico").innerHTML += `<canvas id="myChartCanvas"></canvas>`;
  await obterDadosGrafico();  // Aguarda a função de obter dados antes de continuar
}

// Função para obter dados do gráfico com base no servidor selecionado
async function obterDadosGrafico(valorSelecionado) {
  const empresa = sessionStorage.ID_EMPRESA;
  
  if (!valorSelecionado) {
    console.error("Nenhum servidor selecionado");
    return;
  }

  console.log('Obtendo dados para:', valorSelecionado, 'da empresa:', empresa);

  try {
    const response = await fetch(`/dashboard/feriado/${valorSelecionado}/${empresa}`, { cache: 'no-store' });
    if (response.ok) {
      const resposta = await response.json();
      console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
      plotarGrafico(resposta);
    } else {
      console.error('Nenhum dado encontrado');
    }
  } catch (error) {
    console.error('Erro na obtenção dos dados para o gráfico:', error.message);
  }
}

// Função para plotar o gráfico
function plotarGrafico(resposta) {
  const labels = [];
  const dados = {
    labels: labels,
    datasets: [{
      label: 'Uso de CPU (%)',
      data: [],
      backgroundColor: 'rgba(75, 192, 192, 0.2)',
      borderColor: 'rgba(75, 192, 192, 1)',
      borderWidth: 1,
      tension: 0.1
    }]
  };

  const holidaysTranslation = {
    // Suas traduções aqui...
  };

  resposta.forEach(registro => {
    const dataFormatada = new Date(registro.dataRegistro).toISOString().split('T')[0];
    labels.push(holidaysTranslation[dataFormatada] || dataFormatada);
    dados.datasets[0].data.push(registro.mediaPercentualCPU);
  });

  const config = {
    type: 'bar',
    data: dados,
    options: {
      scales: {
        y: {
          title: {
            display: true,
            text: 'Uso médio do percentual da CPU'
          }
        }
      },
      plugins: {
        legend: {
          display: true,
          displayColors: false,
          labels: {
            usePointStyle: true,
            boxWidth: 0,
            fontColor: 'transparent'
          }
        }
      }
    }
  };

  if (grafico) {
    grafico.destroy();
  }

  // Adiciona o gráfico à tela
  grafico = new Chart(document.getElementById('myChartCanvas'), config);


}

var grafico 



// Chama a função para fazer a requisição inicial e preencher o select
async function inicializar() {
  await servidor(); // Aguarda o preenchimento do select
  exibirPosts();    // Exibe o gráfico após a requisição
}

// Inicia o processo
inicializar();

</script>